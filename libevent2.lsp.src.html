<!DOCTYPE HTML PUBLIC "4.01 Transitional"><META http-equiv="Content-Type" content="text/html; charset=utf-8" /><html><title>Libevent</title><body><pre>
<font color='#555555'>;; <font color='#308080'>@module</font> Libevent</font>
<font color='#555555'>;; <font color='#308080'>@description</font> Low-level newlisp bindings for libevent2.</font>
<font color='#555555'>;; <font color='#308080'>@version</font> 0.1</font>
<font color='#555555'>;; <font color='#308080'>@author</font> Jeff Ober &lt;jeffober@gmail.com&gt;</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> EventCB:EventCB<font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> EventID:EventID<font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'Libevent<font color='#AA0000'>)</font>

<font color='#555555'>;-------------------------------------------------------------------------------</font>
<font color='#555555'>; Constants (from event.h)</font>
<font color='#555555'>;-------------------------------------------------------------------------------</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'TIMEOUT <font color='#665500'>0x01</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'READ    <font color='#665500'>0x02</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'WRITE   <font color='#665500'>0x04</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'SIGNAL  <font color='#665500'>0x08</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'PERSIST <font color='#665500'>0x10</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'EVENT_TYPES <font color='#AA0000'>(</font><font color='#0000AA'>list</font> TIMEOUT READ WRITE SIGNAL PERSIST<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'EVENT_ALL   <font color='#AA0000'>(</font><font color='#0000AA'>apply</font> '| EVENT_TYPES<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;-------------------------------------------------------------------------------</font>
<font color='#555555'>; Locate libevent library</font>
<font color='#555555'>;-------------------------------------------------------------------------------</font>
<font color='#AA0000'>(</font><font color='#0000AA'>constant</font> 'LIB
  <font color='#AA0000'>(</font><font color='#0000AA'>cond</font>
    <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>=</font> ostype <font color='#008800'>"Win32"</font><font color='#AA0000'>)</font> <font color='#008800'>"libevent.dll"</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#AA0000'>(</font><font color='#0000AA'>=</font> ostype <font color='#008800'>"OSX"</font><font color='#AA0000'>)</font>   <font color='#008800'>"libevent.dylib"</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>true</font>               <font color='#008800'>"libevent.so"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>unless</font> <font color='#AA0000'>(</font><font color='#0000AA'>import</font> LIB<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#008800'>"libevent not found"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;-------------------------------------------------------------------------------</font>
<font color='#555555'>; Import libevent routines</font>
<font color='#555555'>;-------------------------------------------------------------------------------</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> LIB <font color='#008800'>"event_enable_debug_mode"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> LIB <font color='#008800'>"event_base_new"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> LIB <font color='#008800'>"event_base_free"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> LIB <font color='#008800'>"event_base_dispatch"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> LIB <font color='#008800'>"event_base_loopbreak"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> LIB <font color='#008800'>"event_new"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> LIB <font color='#008800'>"event_free"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> LIB <font color='#008800'>"event_add"</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>import</font> LIB <font color='#008800'>"event_del"</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>when</font> MAIN:LIBEVENT2_DEBUG
  <font color='#AA0000'>(</font>event_enable_debug_mode<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;-------------------------------------------------------------------------------</font>
<font color='#555555'>; Loop control</font>
<font color='#555555'>;-------------------------------------------------------------------------------</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setf</font> BASE <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setf</font> RUNNING <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (init)</font>
<font color='#555555'>;; Initializes the event loop. Will not re-init a previously initialized</font>
<font color='#555555'>;; loop unless &lt;cleanup&gt; is called first.</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>init<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>or</font> BASE
      <font color='#AA0000'>(</font><font color='#0000AA'>not</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> BASE <font color='#AA0000'>(</font>event_base_new<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
      <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#008800'>"Error initializing event loop"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>assert-initialized<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>or</font> BASE <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#008800'>"Event loop is not initialized"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>cleanup<font color='#AA0000'>)</font>
  <font color='#008800'>"Cleans up memory used by the event loop."</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> RUNNING <font color='#AA0000'>(</font>stop<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>when</font> BASE
    <font color='#AA0000'>(</font>event_base_free BASE<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> BASE <font color='#0000AA'>nil</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (run)</font>
<font color='#555555'>;; Starts the event loop. Does not return until the loop is stopped.</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>run<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> RUNNING <font color='#0000AA'>true</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>case</font> <font color='#AA0000'>(</font>event_base_dispatch BASE<font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#665500'>0</font>  <font color='#0000AA'>true</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#665500'>1</font>  <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#008800'>"No more events registered."</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#665500'>-1</font> <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#008800'>"Unable to start loop."</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (stop)</font>
<font color='#555555'>;; Halts the event loop after the next iteration.</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>stop<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>unless</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> <font color='#AA0000'>(</font>event_base_loopbreak BASE<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#008800'>"Unable to halt event loop."</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> RUNNING <font color='#0000AA'>nil</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>cleanup<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;-------------------------------------------------------------------------------</font>
<font color='#555555'>; Event callback triggering</font>
<font color='#555555'>;-------------------------------------------------------------------------------</font>
<font color='#AA0000'>(</font><font color='#0000AA'>setf</font> _id <font color='#665500'>0</font><font color='#AA0000'>)</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>event-id<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>string</font> <font color='#008800'>"ev-"</font> <font color='#AA0000'>(</font><font color='#0000AA'>inc</font> _id<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>trigger fd ev arg , id event cb<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> id <font color='#AA0000'>(</font><font color='#0000AA'>get-string</font> arg<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>set</font> '<font color='#AA0000'>(</font>event cb<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>EventCB id<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>cb fd ev id<font color='#AA0000'>)</font>
  <font color='#665500'>0</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>setf</font> _event_cb <font color='#AA0000'>(</font><font color='#0000AA'>callback</font> 'trigger <font color='#008800'>"void"</font> <font color='#008800'>"int"</font> <font color='#008800'>"short int"</font> <font color='#008800'>"void*"</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;-------------------------------------------------------------------------------</font>
<font color='#555555'>; Event registration</font>
<font color='#555555'>;-------------------------------------------------------------------------------</font>
<font color='#555555'>;; <font color='#308080'>@syntax</font> (watch &lt;fd&gt; &lt;ev&gt; &lt;cb&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int&gt; 'fd' An open file descriptor</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int&gt; 'ev' A bitmask of event constants</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;fn&gt;  'cb' A callback function</font>
<font color='#555555'>;; <font color='#308080'>@return</font> &lt;int&gt; id used to manage the event watcher</font>
<font color='#555555'>;; Registers callback function &lt;cb&gt; to be called whenever an event masked in</font>
<font color='#555555'>;; &lt;ev&gt; is triggered for &lt;fd&gt;. &lt;cb&gt; is called with the file descriptor,</font>
<font color='#555555'>;; event, and id as its arguments.</font>
<font color='#555555'>;;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (watch socket (| READ WRITE)</font>
<font color='#555555'>;;   (fn (fd e)</font>
<font color='#555555'>;;     (cond</font>
<font color='#555555'>;;       (== e READ) (...)</font>
<font color='#555555'>;;       (== e WRITE) (...))))</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>watch fd ev cb once , id event<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>assert-initialized<font color='#AA0000'>)</font>

  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> id <font color='#AA0000'>(</font>event-id<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>EventID id id<font color='#AA0000'>)</font> <font color='#555555'>; anchor in memory</font>

  <font color='#AA0000'>(</font><font color='#0000AA'>unless</font> once
    <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> ev <font color='#AA0000'>(</font><font color='#0000AA'>|</font> ev PERSIST<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

  <font color='#AA0000'>(</font><font color='#0000AA'>setf</font> event <font color='#AA0000'>(</font>event_new BASE fd ev _event_cb <font color='#AA0000'>(</font><font color='#0000AA'>address</font> <font color='#AA0000'>(</font>EventID id<font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>EventCB id <font color='#AA0000'>(</font><font color='#0000AA'>list</font> event cb<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

  <font color='#AA0000'>(</font><font color='#0000AA'>unless</font> <font color='#AA0000'>(</font><font color='#0000AA'>zero?</font> <font color='#AA0000'>(</font>event_add event <font color='#665500'>0</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>
    <font color='#AA0000'>(</font><font color='#0000AA'>throw-error</font> <font color='#008800'>"Error adding event watcher."</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

  id<font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (unwatch &lt;id&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int&gt; 'id' ID returned by &lt;watch&gt;</font>
<font color='#555555'>;; Unregisters an event watcher. Once unwatched, the watcher id is invalid</font>
<font color='#555555'>;; and may no longer be used.</font>
<font color='#555555'>;;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (watch socket WRITE</font>
<font color='#555555'>;;   (lambda (fd e id)</font>
<font color='#555555'>;;     (unwatch id)</font>
<font color='#555555'>;;     (write fd "Hello world")))</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>unwatch id , event cb<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>assert-initialized<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font><font color='#0000AA'>map</font> <font color='#0000AA'>set</font> '<font color='#AA0000'>(</font>event cb<font color='#AA0000'>)</font> <font color='#AA0000'>(</font>EventCB id<font color='#AA0000'>)</font><font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>event_del event<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>event_free event<font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#555555'>;; <font color='#308080'>@syntax</font> (once &lt;fd&gt; &lt;ev&gt; &lt;cb&gt;)</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int&gt; 'fd' An open file descriptor</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;int&gt; 'ev' A bitmask of event constants</font>
<font color='#555555'>;; <font color='#308080'>@param</font> &lt;fn&gt;  'cb' A callback function</font>
<font color='#555555'>;; Registers a callback &lt;cb&gt; for events &lt;ev&gt; on descriptor &lt;fd&gt;. After the</font>
<font color='#555555'>;; callback is triggered, it is automatically unregistered for events &lt;ev&gt;.</font>
<font color='#555555'>;; For example, the example code from &lt;unwatch&gt; could be rewritten as:</font>
<font color='#555555'>;;</font>
<font color='#555555'>;; <font color='#308080'>@example</font></font>
<font color='#555555'>;; (once socket WRITE</font>
<font color='#555555'>;;   (lambda (fd e)</font>
<font color='#555555'>;;     (write fd "Hello world")))</font>
<font color='#AA0000'>(</font><font color='#0000AA'>define</font> <font color='#AA0000'>(</font>once fd ev cb<font color='#AA0000'>)</font>
  <font color='#AA0000'>(</font>watch fd ev cb <font color='#0000AA'>true</font><font color='#AA0000'>)</font><font color='#AA0000'>)</font>

<font color='#AA0000'>(</font><font color='#0000AA'>context</font> 'MAIN<font color='#AA0000'>)</font>



</pre><center><font face='Arial' size='-3' color='#666666'>syntax highlighting with <a href="http://newlisp.org">newLISP</a>&nbsp;and <a href="http://newlisp.org/newLISPdoc.html">newLISPdoc</a></font></center></body></html>